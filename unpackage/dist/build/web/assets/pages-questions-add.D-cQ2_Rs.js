import{Z as e,a as t,z as a,s as i,h as s,y as o,r as l,c as r,w as u,l as n,o as c,b as d,d as m,L as f,B as h}from"./index-nnZW9WDd.js";import{_ as p}from"./uni-easyinput.o8bItaYz.js";import{r as _}from"./uni-app.es.YMhB4L0_.js";import{_ as k}from"./uni-forms-item.CBR7qWz9.js";import{v as g,_ as y}from"./questions.CwRmQra4.js";import{_ as D}from"./uni-file-picker.xRZRjom7.js";import{_ as b}from"./uni-forms.Ds0BSXHg.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.BTZacCfd.js";import"./uni-load-more.CaYHO8__.js";const x=e.database();function V(e){let t={};for(let a in g)e.indexOf(a)>-1&&(t[a]=g[a]);return t}const v=w({data(){let e={title:"",descrip:"",difficulties:null,category:"",images:[],is_stick:null};return{formData:e,formOptions:{difficulties_localdata:[{text:"简单",value:0},{text:"中等",value:1},{text:"困难",value:2}],category_localdata:[{text:"数学题",value:"math"},{text:"编程题",value:"code"},{text:"求资料",value:"resource"},{text:"其他",value:"other"}]},rules:{...V(Object.keys(e))},stick_costs:0,current_user:null}},onReady(){this.$refs.form.setRules(this.rules)},methods:{async tryToStickQuestion(){const i=e.getCurrentUserInfo();if(i.tokenExpired<Date.now())return t({title:"请先登录",icon:"none"}),!1;this.current_user=i;let s=null;try{s=(await x.collection("uni-id-users").where(`_id == "${i.uid}"`).field("_id, stick_costs, workhour").get()).result.data[0]}catch(o){return console.error("获取用户信息失败",o),!1}return s.stick_costs||(s.stick_costs=0),s.workhour||(s.workhour=0),s.stick_costs+this.difficultiesToTime(this.formData.difficulties)>s.workhour?(a({title:"工时不足",content:`当前已花费: ${s.stick_costs}分钟工时\n还需要${-(s.workhour-s.stick_costs-this.difficultiesToTime(this.formData.difficulties))}分钟工时`,showCancel:!1}),!1):(this.stick_costs=s.stick_costs+this.difficultiesToTime(this.formData.difficulties),!0)},submit(){i({mask:!0}),this.$refs.form.validate().then((e=>(console.log(e),!!(e.category&&e.descrip&&e.difficulties&&e.title)&&this.submitForm(e)))).catch((()=>{})).finally((()=>{s()}))},submitForm(e){return x.collection("questions").add(e).then((e=>{t({icon:"none",title:"新增成功"}),this.formData.is_stick&&x.collection("uni-id-users").where(`_id == "${this.current_user.uid}"`).update({stick_costs:this.stick_costs}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>o()),500)})).catch((e=>{a({content:e.message||"请求服务失败",showCancel:!1})}))},handleSwitchChange(e){this.tryToStickQuestion().then((t=>{this.binddata("is_stick",!!t&&e.detail.value)}))},difficultiesToTime:e=>0==e?5:1==e?10:15}},[["render",function(e,t,a,i,s,o){const g=_(l("uni-easyinput"),p),w=_(l("uni-forms-item"),k),x=_(l("uni-data-checkbox"),y),V=_(l("uni-file-picker"),D),v=f,j=h,C=n,T=_(l("uni-forms"),b);return c(),r(C,{class:"uni-container"},{default:u((()=>[d(T,{ref:"form",model:s.formData,"validate-trigger":"submit","err-show-type":"toast"},{default:u((()=>[d(w,{required:!0,name:"title",label:"标题"},{default:u((()=>[d(g,{placeholder:"标题",modelValue:s.formData.title,"onUpdate:modelValue":t[0]||(t[0]=e=>s.formData.title=e)},null,8,["modelValue"])])),_:1}),d(w,{required:!0,name:"descrip",label:"详情"},{default:u((()=>[d(g,{type:"textarea",autoHeight:"",placeholder:"描述你的问题",modelValue:s.formData.descrip,"onUpdate:modelValue":t[1]||(t[1]=e=>s.formData.descrip=e)},null,8,["modelValue"])])),_:1}),d(w,{required:!0,name:"difficulties",label:"难度"},{default:u((()=>[d(x,{modelValue:s.formData.difficulties,"onUpdate:modelValue":t[2]||(t[2]=e=>s.formData.difficulties=e),localdata:s.formOptions.difficulties_localdata},null,8,["modelValue","localdata"])])),_:1}),d(w,{required:!0,name:"category",label:"类型"},{default:u((()=>[d(x,{modelValue:s.formData.category,"onUpdate:modelValue":t[3]||(t[3]=e=>s.formData.category=e),localdata:s.formOptions.category_localdata},null,8,["modelValue","localdata"])])),_:1}),d(w,{name:"images",label:"添加照片"},{default:u((()=>[d(V,{"file-mediatype":"image","file-extname":"jpg,png",limit:3,"return-type":"array",modelValue:s.formData.images,"onUpdate:modelValue":t[4]||(t[4]=e=>s.formData.images=e)},null,8,["modelValue"])])),_:1}),d(w,{name:"is_stick",label:"置顶"},{default:u((()=>[d(v,{onChange:o.handleSwitchChange,checked:s.formData.is_stick},null,8,["onChange","checked"])])),_:1}),d(C,{class:"uni-button-group"},{default:u((()=>[d(j,{type:"primary",class:"uni-button",onClick:o.submit},{default:u((()=>[m("提交")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["model"])])),_:1})}],["__scopeId","data-v-181db747"]]);export{v as default};
